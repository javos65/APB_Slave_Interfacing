
/*
 *
 * SSD1351 setup and Routines
 *
 * J.Vos 2025
 *
 * Setup display in Serial 4-wire interface (CS,DC,SDIN,SCLK)
 * Column scan left to right (0,0 upper left)
 * Color depth 65K: RGB565 in 16b but data [RRRRRGG] [GGBBBBB]. Serial send MSB - LSB order
 *
 *
 */

#include "ssd1351.h"

const uint8_t initList[] = {
    SSD1351_CMD_COMMANDLOCK, 1, 0x12,  	// Set command lock, 1 arg
    SSD1351_CMD_COMMANDLOCK, 1, 0xB1, 	// Set command lock, 1 arg
    SSD1351_CMD_DISPLAYOFF, 0, 			// Display off, no args
    SSD1351_CMD_CLOCKDIV, 1,0xF1, 		// 7:4 = Oscillator Freq, 3:0 = CLK Div Ratio (A[3:0]+1 = 1..16)
    SSD1351_CMD_MUXRATIO, 1, 127,
	SSD1351_CMD_SETREMAP, 1, ORIENTATION_1,      // set color order C->B->A, = RGB565 RRRRRGGG GGGBBBBB, set ColN-Col0 scan : 0,0 is top-left
    SSD1351_CMD_DISPLAYOFFSET, 1, 0x0,
    SSD1351_CMD_SETGPIO, 1, 0x00,
    SSD1351_CMD_FUNCTIONSELECT, 1, 0x01, // internal (diode drop)
    SSD1351_CMD_PRECHARGE, 1, 0x32,
    SSD1351_CMD_VCOMH, 1, 0x05,
    SSD1351_CMD_NORMALDISPLAY, 0,
	SSD1351_CMD_CONTRASTABC, 3, 0xC8, 0x80, 0xC8,
    SSD1351_CMD_CONTRASTMASTER, 1, 0x0F,
    SSD1351_CMD_SETVSL, 3,0xA0,0xB5,0x55,
    SSD1351_CMD_PRECHARGE2, 1, 0x01,
    SSD1351_CMD_DISPLAYON, 0,  // Main screen turn on
    0}; // END OF COMMAND LIST


uint32_t SPI_BASE; 		// Base Memory Mapped address
uint8_t COL_start=0;
uint8_t COL_end=127;
uint8_t ROW_start=0;
uint8_t ROW_end=127;

void set_orientation(uint8_t orientation)
{
	command_ssd1351(SSD1351_CMD_SETREMAP);
	data_ssd1351(orientation);
}

void draw_testpattern()
{
	draw_rectangle(8,8,112,112,GRAY);
	draw_rectangle(16,16,8,16,RED);
	draw_rectangle(16,104,16,8,BLUE);
	draw_rectangle(96,16,16,4,GREEN);
	draw_rectangle(104,104,8,8,YELLOW);
	draw_lattice_logo(46,46,8);
	//draw_image(47,47, LOGO_WIDTH, LOGO_HEIGHT,logo_1); // write Logo
}

void draw_lattice_logo(uint8_t x,uint8_t y,uint8_t s)
{

	uint8_t spacer = s/4;
	uint8_t xo = x+s/2;
	uint8_t yo = y+s/2;
	draw_rectangle(x				,y				,(9*s)/2	,(9*s)/2,BLACK); 	// s/2 + 3*s + 2*s/4 + s/2 = s*4.5 = size

	draw_rectangle(xo				,yo				,s,s,GOLD);
	draw_rectangle(xo+s+spacer		,yo				,s,s,WHITE);
	draw_rectangle(xo+2*(s+spacer)	,yo				,s,s,WHITE);

	draw_rectangle(xo				,yo+s+spacer	,s,s,GOLD);
	draw_rectangle(xo+s+spacer		,yo+s+spacer	,s,s,WHITE);
	draw_rectangle(xo+2*(s+spacer)	,yo+s+spacer	,s,s,WHITE);

	draw_rectangle(xo				,yo+2*(s+spacer),s,s,GOLD);
	draw_rectangle(xo+s+spacer		,yo+2*(s+spacer),s,s,GOLD);
	draw_rectangle(xo+2*(s+spacer)	,yo+2*(s+spacer),s,s,GOLD);

}


void draw_image(uint8_t x,uint8_t y,uint8_t w,uint8_t h,const uint16_t *i)
{
	uint32_t c=0;
	set_block(x,x+w-1,y,y+h-1);
	command_ssd1351(SSD1351_CMD_WRITERAM);
	for(uint8_t x = COL_start;x<=COL_end;x++ )
		for(uint8_t y = ROW_start;y<=ROW_end;y++ )
			{
			data_ssd1351((uint8_t) (i[c]>>8) );
			data_ssd1351( (uint8_t) (i[c]) );
			c++;
			}
	printf("Image draw [%d] pixels\n",c);
}

void draw_rectangle(uint8_t x,uint8_t y,uint8_t w,uint8_t h,uint16_t color)
{
	set_block(x,x+w-1,y,y+h-1);
	fill_block(color);
}

void set_block(uint8_t c0,uint8_t c1,uint8_t r0,uint8_t r1)
{
	COL_start=c0;COL_end=c1;
	ROW_start=r0;ROW_end=r1;
	command_ssd1351(SSD1351_CMD_SETCOLUMN);	data_ssd1351(c0);data_ssd1351(c1);
	command_ssd1351(SSD1351_CMD_SETROW);	data_ssd1351(r0);data_ssd1351(r1);
}

void fill_block(uint16_t color) // 16 bits color : RGB565
{
	command_ssd1351(SSD1351_CMD_WRITERAM);
	for(uint8_t x = COL_start;x<=COL_end;x++ )
		for(uint8_t y = ROW_start;y<=ROW_end;y++ )
			{
			data_ssd1351((uint8_t) (color>>8) );
			data_ssd1351( (uint8_t) (color) );
			}
}

// set SPI base address - check sys_platform.h
void base_ssd1351(uint32_t address)
{
	SPI_BASE = address;
}

uint8_t wait_spi_ready()
 {
	uint32_t x;
	for(uint8_t t=0;t<16;++t){
		x=*( (uint32_t*) (SPI_BASE + STATUS_REGISTER ) );
		if ( x && 0x00000001 ) return(1);
		delay(1);
	}
	printf("* spi timeout\n");
	return(0);
 }

uint8_t command_ssd1351(uint8_t command)
{
	if (wait_spi_ready() )
	{
		*( (uint32_t*) (SPI_BASE + DATA_REGISTER)) = 0x00000000 + command;
		*( (uint32_t*) (SPI_BASE + CONTROL_REGISTER)) = 0x00000001;
		//printf("C[0x%02X],",command);
		return(1);
	}
	return(0); // failure
}


uint8_t data_ssd1351(uint8_t data)
{
	if (wait_spi_ready() )
	{
		*( (uint32_t*) (SPI_BASE + DATA_REGISTER)) = 0x00000100 + data;
		*( (uint32_t*) (SPI_BASE + CONTROL_REGISTER)) = 0x00000001;
		//printf("D[0x%02X],",data);
		return(1);
	}
	else return(0); // failure
}

void writeSPIMemory(uint8_t offset,uint32_t data)
{
*( (uint32_t*) (SPI_BASE + offset)) = data;
}

uint32_t readSPIMemory(uint8_t offset)
{
return ( *( (uint32_t*) (SPI_BASE + offset) ) );
}


void  init_ssd1351() {

  uint32_t addr =0;
  uint8_t cmd, x, numArgs;

  while ((cmd = initList[addr++]) > 0) { // '0' command ends list
	numArgs = initList[addr++];  //
    if (cmd != 0xFF) { // '255' is ignored
    	command_ssd1351(cmd);
    	for(uint8_t t=0;t<numArgs;++t) data_ssd1351(initList[addr++]);
    	//printf("\n");
    	}
  }
  //setRotation(0);
}

// draw_image(x,y,LOGO_L_WIDTH,LOGO_L_HEIGHT,&logo_l[0]);
#define LOGO_HEIGHT 32
#define LOGO_WIDTH 32

// array size is 2048
  const uint16_t logo_1[1024]  = {
		  0xdefb, 0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef7c, 0xeef8, 0xee50, 0xe587, 0xe522, 0xe522, 0xe543, 0xe543, 0xe543, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe523, 0xe522, 0xe566,
		  0xf79e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xfffe, 0xfef3, 0xf5a5, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0xef7d, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xff58, 0xf5e6, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0xef7d, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xff36, 0xf5a5, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0x9cf6, 0xa558, 0xa558, 0xa558, 0xa558, 0xa558, 0xa558, 0xa558, 0xad99, 0xdedc, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xf6b0, 0xf582, 0xf582, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0x192c, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x216d, 0x6352, 0xdefc, 0xffff, 0xffff, 0xffff, 0xffff, 0xff9a, 0xf5e8, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x216e, 0x10cc, 0x4270, 0xdedc, 0xffff, 0xffff, 0xffff, 0xffff, 0xfe8e, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c7,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x08ac, 0x73f4, 0xef7e, 0xffff, 0xffff, 0xffff, 0xfef3, 0xf583, 0xf562, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5c6,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x192d, 0x3a0f, 0xd69b, 0xffff, 0xffff, 0xffff, 0xff57, 0xf5c6, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf609,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x216d, 0x214d, 0xbdfa, 0xffff, 0xffff, 0xffff, 0xff79, 0xf5e7, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf5a5, 0xff57,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x216d, 0x194d, 0xbdfa, 0xffff, 0xffff, 0xffff, 0xff79, 0xf5e7, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf582, 0xf583, 0xf6b0, 0xffff,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x192d, 0x31ef, 0xce9b, 0xffff, 0xffff, 0xffff, 0xff57, 0xf5c6, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf62a, 0xfffe, 0xffff,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x08cc, 0x6b93, 0xef5d, 0xffff, 0xffff, 0xffff, 0xfef4, 0xf584, 0xf562, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf5c7, 0xff7a, 0xffff, 0xffff,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x10ec, 0x31ef, 0xce7b, 0xffff, 0xffff, 0xffff, 0xffff, 0xf68f, 0xf562, 0xf582, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf584, 0xfef3, 0xffff, 0xffff, 0xffff,
		  0x216d, 0x218e, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x192d, 0x110c, 0x3a30, 0xc63a, 0xffff, 0xffff, 0xffff, 0xffff, 0xff9a, 0xf5e8, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf582, 0xf562, 0xf66d, 0xffff, 0xffff, 0xffff, 0xffff,
		  0x216d, 0x29ae, 0x6b93, 0x73d4, 0x73d4, 0x73d4, 0x73d4, 0x73d4, 0x7c14, 0xad98, 0xf79e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xf68f, 0xf562, 0xf582, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf608, 0xffbb, 0xffff, 0xffff, 0xffff, 0xffff,
		  0x214d, 0x320f, 0xf79e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xff15, 0xf5a4, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf5a5, 0xff36, 0xffff, 0xffff, 0xffff, 0xffff, 0xef7e,
		  0x214d, 0x31ef, 0xef7e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xff15, 0xf5a5, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf582, 0xf562, 0xf6b0, 0xffff, 0xffff, 0xffff, 0xffff, 0xe71d, 0x7c35,
		  0x216d, 0x194d, 0x94b6, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffbc, 0xfe8f, 0xf583, 0xf562, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf62b, 0xffdd, 0xffff, 0xffff, 0xffff, 0xffdf, 0x94d7, 0x216d,
		  0x216d, 0x216e, 0x192d, 0xb5b9, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff, 0xffdd, 0xff37, 0xf68e, 0xf5a5, 0xf562, 0xf582, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf5c6, 0xff58, 0xffff, 0xffff, 0xffff, 0xffff, 0xc65b, 0x216d, 0x29ae,
		  0x216d, 0x298e, 0x214d, 0x29ae, 0xce7b, 0xffff, 0xffff, 0xffff, 0xffff, 0xffdd, 0xf609, 0xf540, 0xf582, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf562, 0xf583, 0xfed2, 0xffff, 0xffff, 0xffff, 0xffff, 0xdefd, 0x52d1, 0x08ab, 0x3a0f,
		  0x216d, 0x298e, 0x298e, 0x192d, 0x4230, 0xe71d, 0xffff, 0xffff, 0xffff, 0xffff, 0xff9b, 0xf5e7, 0xf562, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf66d, 0xfffe, 0xffff, 0xffff, 0xffff, 0xf79e, 0x8455, 0x10cc, 0x194d, 0x3a0f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x110c, 0x5b12, 0xef7e, 0xffff, 0xffff, 0xffff, 0xffff, 0xff57, 0xf5a5, 0xf561, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf583, 0xf560, 0xf5e8, 0xff7a, 0xffff, 0xffff, 0xffff, 0xffff, 0xb5b9, 0x214d, 0x214d, 0x214d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x10ec, 0x7bf4, 0xf79e, 0xffff, 0xffff, 0xffff, 0xffff, 0xff14, 0xf5a4, 0xf562, 0xf583, 0xf583, 0xf583, 0xf583, 0xf561, 0xf583, 0xff14, 0xffff, 0xffff, 0xffff, 0xffff, 0xd6bc, 0x4250, 0x110c, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x218e, 0x10ec, 0x9cf7, 0xf7bf, 0xffff, 0xffff, 0xffff, 0xffff, 0xfeb1, 0xf583, 0xf562, 0xf583, 0xf583, 0xf582, 0xf561, 0xfeb0, 0xffff, 0xffff, 0xffff, 0xffff, 0xef5d, 0x6bb3, 0x10cc, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x216d, 0x214d, 0xb5b9, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff, 0xf66e, 0xf562, 0xf582, 0xf583, 0xf540, 0xf62a, 0xffbb, 0xffff, 0xffff, 0xffff, 0xffff, 0x9cf7, 0x192d, 0x216d, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x192d, 0x29ae, 0xce7b, 0xffff, 0xffff, 0xffff, 0xffff, 0xffde, 0xf64b, 0xf561, 0xf560, 0xf5a5, 0xff57, 0xffff, 0xffff, 0xffff, 0xffff, 0xbe1a, 0x31ce, 0x192d, 0x298e, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x110c, 0x4290, 0xdefc, 0xffff, 0xffff, 0xffff, 0xffff, 0xffbb, 0xf5e8, 0xf540, 0xfed2, 0xffff, 0xffff, 0xffff, 0xffff, 0xdefc, 0x5af2, 0x10ec, 0x298e, 0x298e, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x10ec, 0x5b52, 0xe73d, 0xffff, 0xffff, 0xffff, 0xffff, 0xff36, 0xf6d1, 0xff9b, 0xffff, 0xffff, 0xffff, 0xffdf, 0x8455, 0x110c, 0x216e, 0x298e, 0x298e, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x218e, 0x10cc, 0x8455, 0xf79e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xad78, 0x216d, 0x192d, 0x298e, 0x298e, 0x298e, 0x298e, 0x298e, 0x194d, 0x320f,
		  0x216d, 0x218e, 0x218e, 0x218e, 0x218e, 0x218e, 0x218e, 0x218e, 0x218e, 0x218e, 0x214d, 0x110c, 0x9cf7, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xce7b, 0x4250, 0x10ec, 0x218e, 0x216e, 0x216e, 0x216e, 0x216e, 0x218e, 0x192d, 0x31ef,
		  0x298d, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ae, 0x29ce, 0x216d, 0x29ad, 0xad98, 0xef9d, 0xef9d, 0xef9d, 0xef9d, 0xef9d, 0xef9d, 0xe71c, 0x73b3, 0x214c, 0x31ce, 0x31ce, 0x31ce, 0x31ce, 0x31ce, 0x31ce, 0x31ce, 0x298d, 0x3a2f
		};
